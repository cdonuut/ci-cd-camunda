name: Camunda CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Zeebe Process Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Run tests
        run: mvn clean test

  deploy:
    name: Deploy to Camunda SaaS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Zeebe Bearer Token
        id: get_token
        run: |
          RESPONSE=$(curl -s --request POST \
            --url https://login.cloud.camunda.io/oauth/token \
            --header 'content-type: application/json' \
            --data '{
              "grant_type":"client_credentials",
              "client_id":"${{ secrets.CAMUNDA_CLIENT_ID }}",
              "client_secret":"${{ secrets.CAMUNDA_CLIENT_SECRET }}",
              "audience":"${{ secrets.CAMUNDA_AUTH_AUDIENCE }}"
            }')

          echo "TOKEN RESPONSE: $RESPONSE"  # show full response for debugging

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [[ "$ACCESS_TOKEN" == "null" || -z "$ACCESS_TOKEN" ]]; then
            echo "âŒ Failed to extract access_token from response"
            exit 1
          fi

          echo "::add-mask::$ACCESS_TOKEN"
          echo "token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy models to Camunda SaaS
        run: |
            echo "Finding and deploying all models..."
            
            FORM_DATA=$(find src/main/resources/processes src/main/resources/forms src/main/resources/dmns -type f -exec echo -n "-F files=@{} " \;)
            
            echo "Files to deploy: $FORM_DATA"
            
            eval curl -X POST https://bru-2.zeebe.camunda.io:443/${{ secrets.CAMUNDA_PROJECT_ID }}/v2//deployments \
              -H "Authorization: Bearer ${{ steps.get_token.outputs.token }}" \
              -H "Content-Type: multipart/form-data" \
              $FORM_DATA