name: Camunda CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Zeebe Process Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Run tests
        run: mvn clean test

  deploy:
    name: Deploy to Camunda SaaS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Zeebe Bearer Token
        uses: .actions/get-bearer-token
        id: get_token

      - name: Prepare model files
        run: |
          mkdir deploy
          cp src/main/resources/processes/*.bpmn deploy/ || true
          cp src/main/resources/forms/*.form deploy/ || true
          cp src/main/resources/dmns/*.dmn deploy/ || true

      - name: Deploy models to Camunda SaaS
        run: |
          echo "Finding and deploying all models..."

          FORM_DATA=$(find deploy -type f -exec printf -- "-F files=@\"%s\" " {} \;)

          echo "Files to deploy: $FORM_DATA"

          curl -X POST "https://bru-2.zeebe.camunda.io:443/${{ secrets.CAMUNDA_CLUSTER_ID }}/v2/deployments" \
            -H "Authorization: Bearer ${{ steps.get_token.outputs.token }}" \
            -H "Content-Type: multipart/form-data" \
            $FORM_DATA